<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Dashboard | RISA Labs Decision Support</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fcfcfd; color: #1a1c1e; line-height: 1.5; }
        .clinical-card { background: white; border: 1px solid #e9eaec; border-radius: 2px; }
        .status-badge { padding: 2px 6px; border-radius: 2px; font-size: 10px; font-weight: 700; text-transform: uppercase; border: 1px solid transparent; }
        .bg-pd { background-color: #fff1f2; color: #9f1239; border-color: #fecdd3; }
        .bg-pr { background-color: #f0fdf4; color: #166534; border-color: #dcfce7; }
        .bg-sd { background-color: #eff6ff; color: #1e40af; border-color: #dbeafe; }
        .bg-cr { background-color: #faf5ff; color: #6b21a8; border-color: #f3e8ff; }
        .bg-baseline { background-color: #f8fafc; color: #475569; border-color: #e2e8f0; }
        .timeline-line { position: absolute; left: 7px; top: 0; bottom: 0; width: 1px; background: #e2e8f0; }
        .next-steps-box { background-color: #eef2ff; border: 1px solid #c7d2fe; border-radius: 4px; }
        .timeline-dot { width: 14px; height: 14px; border-radius: 50%; background: white; border: 2px solid #cbd5e1; position: relative; z-index: 10; }
        .timeline-dot.active { border-color: #4f46e5; background: #4f46e5; }
        .ai-panel { background-color: #f8faff; border: 1px solid #e0e7ff; border-radius: 2px; }
        select { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em; }
    </style>
</head>
<body class="p-6 lg:p-8 max-w-[1400px] mx-auto">

    <!-- 1) PATIENT SELECTOR & HEADER -->
    <div class="flex flex-col md:flex-row md:items-end justify-between mb-6 gap-4 border-b border-slate-100 pb-6">
        <div class="space-y-1">
            <h1 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Clinical Review Interface</h1>
            <div class="flex items-center gap-3">
                <select id="patientSelect" onchange="loadPatient()" class="w-64 p-2 text-sm font-bold border border-slate-200 rounded-sm outline-none focus:border-indigo-500 transition-colors">
                </select>
            </div>
        </div>
    </div>

    <div id="clinicalUpdates" class="mb-8 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-sm shadow-sm">
        </div>

    <!-- 2) TOP SUMMARY CARD -->
    <div id="topSummary" class="clinical-card p-5 mb-8 flex flex-wrap items-center justify-between gap-6 border-l-4 border-l-slate-800">
    </div>

    <div class="grid grid-cols-12 gap-8">
        <!-- LEFT COLUMN -->
        <div class="col-span-12 lg:col-span-8 space-y-8">
            <section class="clinical-card p-6">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="line-chart" class="w-4 h-4"></i> Longitudinal Disease Course
                    </h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-10 gap-8">
                    <div id="timelineContainer" class="md:col-span-4 space-y-6 relative ml-2">
                        <div class="timeline-line"></div>
                    </div>
                    <div class="md:col-span-6 border-l border-slate-50 pl-4 h-64">
                        <canvas id="biomarkerChart"></canvas>
                    </div>
                </div>
            </section>

            <section class="clinical-card p-6">
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-6 flex items-center gap-2">
                    <i data-lucide="database" class="w-4 h-4"></i> Treatment History (By Line)
                </h2>
                <div id="treatmentLines" class="space-y-3"></div>
            </section>

            <section class="clinical-card p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="activity" class="w-4 h-4"></i> Labs & Safety Monitor
                    </h2>
                    <span class="text-[9px] font-medium text-slate-400 italic bg-slate-50 px-2 py-1 rounded border border-slate-100">
                        For monitoring trends only. Not for Rx decisions.
                    </span>
                </div>
                <div id="labsGrid"></div>
            </section>
        </div>

        <!-- RIGHT COLUMN -->
        <div class="col-span-12 lg:col-span-4 space-y-8">
            <section class="ai-panel p-6 border-t-2 border-t-indigo-500">
                <h2 class="text-xs font-black text-indigo-900 uppercase tracking-widest mb-5 flex items-center gap-2">
                    <i data-lucide="sparkles" class="w-3.5 h-3.5 text-indigo-600"></i> AI-Assisted Clinical Summary (For Review Only)
                </h2>
                <ul id="aiSummaryPoints" class="space-y-4 text-[12px] text-slate-700 font-medium"></ul>



                
<div class="next-steps-box p-4 mt-6">
    <div class="flex items-center gap-2 mb-2">
        <i data-lucide="arrow-right-circle" class="w-3.5 h-3.5 text-indigo-600"></i>
        <span class="text-[10px] font-black text-indigo-900 uppercase tracking-widest">Clinical Considerations (Next Steps)</span>
    </div>
    <ul id="aiNextSteps" class="space-y-2 text-[11px] text-indigo-800 font-semibold leading-snug list-disc pl-4">
        <!-- Next steps will be injected here -->
    </ul>
</div>




                
            </section>

            <section class="clinical-card p-6">
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-5 flex items-center gap-2">
                    <i data-lucide="dna" class="w-4 h-4"></i> Molecular Profile
                </h2>
                <div id="molecularList" class="space-y-4"></div>
            </section>
        </div>
    </div>

    <div id="sidebarBackdrop" onclick="closeSidebar()" class="fixed inset-0 bg-slate-900/20 backdrop-blur-[1px] z-40 hidden transition-opacity opacity-0"></div>

<div id="eventSidebar" class="fixed top-0 right-0 bottom-0 w-[450px] bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col border-l border-slate-100">
    
    <div class="p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-start">
        <div>
            <div id="sidebarDate" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1"></div>
            <h3 id="sidebarEvent" class="text-lg font-bold text-slate-800 leading-tight"></h3>
        </div>
        <button onclick="closeSidebar()" class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-slate-600 transition-colors">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>

    <div class="flex-1 overflow-y-auto p-6 space-y-6">
        
        <div class="flex items-center justify-between bg-slate-50 p-3 rounded border border-slate-100">
            <span class="text-xs font-semibold text-slate-500">Clinical Impact</span>
            <span id="sidebarBadge"></span>
        </div>

        <div id="sidebarContent" class="space-y-6">
            </div>
    </div>

    <div class="p-4 border-t border-slate-100 bg-slate-50 text-right">
        <span class="text-[10px] text-slate-400 italic mr-2">Signed electronically</span>
        <button onclick="closeSidebar()" class="px-4 py-2 bg-indigo-600 text-white text-xs font-bold rounded shadow-sm hover:bg-indigo-700 transition-colors">Done</button>
    </div>
</div>

    <div class="p-4 border-t border-slate-100 bg-slate-50 text-right">
        <span class="text-[10px] text-slate-400 italic mr-2">Signed electronically</span>
        <button onclick="closeSidebar()" class="px-4 py-2 bg-indigo-600 text-white text-xs font-bold rounded shadow-sm hover:bg-indigo-700 transition-colors">Done</button>
    </div>
</div>

<div id="labSidebarBackdrop" onclick="closeLabSidebar()" class="fixed inset-0 bg-slate-900/20 backdrop-blur-[1px] z-[60] hidden transition-opacity opacity-0"></div>

<div id="labSidebar" class="fixed top-0 right-0 bottom-0 w-[500px] bg-white shadow-2xl z-[70] transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col border-l border-slate-100">
    
    <div class="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
        <div>
            <h3 id="labSidebarTitle" class="text-lg font-black text-slate-800 uppercase tracking-tight"></h3>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Safety & Trend Analysis</p>
        </div>
        <button onclick="closeLabSidebar()" class="p-2 hover:bg-slate-200 rounded-full text-slate-400 hover:text-slate-600 transition-colors">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>

    <div class="flex-1 overflow-y-auto p-6">
        
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="bg-indigo-50/50 p-4 rounded border border-indigo-100">
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Current Level</span>
                <div class="flex items-baseline gap-1">
                    <span id="labSidebarValue" class="text-3xl font-black text-indigo-900"></span>
                    <span id="labSidebarUnit" class="text-xs font-bold text-indigo-400"></span>
                </div>
            </div>
            <div class="flex flex-col justify-center pl-4 border-l border-slate-100">
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Reference Range</span>
                <div id="labSidebarRange" class="text-sm font-bold text-slate-600 mb-2"></div>
                <div id="labSidebarStatus"></div>
            </div>
        </div>

        <div class="mb-6">
            <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                <i data-lucide="activity" class="w-3 h-3"></i> Historical Trend
            </h4>
            <div class="h-[280px] w-full relative border border-slate-100 rounded bg-slate-50/30 p-2">
                <canvas id="sidebarLabChart"></canvas>
            </div>
            <div class="mt-3 text-[10px] text-slate-400 italic text-center">
                <span class="inline-block w-3 h-0.5 bg-red-400 align-middle mr-1"></span> Dashed lines indicate normal safety limits.
            </div>
        </div>

    </div>

    <div class="p-4 border-t border-slate-100 bg-slate-50 text-center">
        <p class="text-[10px] text-slate-400 font-medium">
            Data is for clinical monitoring only. Treat per protocol guidelines.
        </p>
    </div>
</div>

    <script>
        const PATIENTS = [
        {
            ID: "PT-101", Name: "Eleanor Vance", Dx: "NSCLC (Adeno)", Stage: "IVA", Age: 62, Sex: "F", Line: 2, PS: "ECOG 1",
            History: ["CEA normalized from 12.5 to 4.2 following L2 transition.", "Primary mass reduced 50% on 2024-12-08 CT."],
            EGFR: "Exon 19 del", ALK: "Negative", KRAS: "Negative", PDL1: "75%", MSI: "MSS", TMB: "8",
            Biology: "Informational: EGFR exon 19 deletion is associated with potential sensitivity to 3rd-generation EGFR TKIs.",
            Treatments: [
                { 
                    line: 1, drug: "Carbo + Pemetrexed", start: "2023-03", end: "2024-05", resp: "SD", stop: "Progression",
                    extended: {
                        rationale: "Standard 1L systemic therapy initiated pending NGS results. Histology consistent with non-squamous disease.",
                        dosing: "Carboplatin AUC 5 + Pemetrexed 500mg/m2 q3w x 4 cycles -> Maint Pemetrexed.",
                        toxicity: "Course complicated by Grade 2 anemia requiring support. G1 fatigue persistent. No dose reductions.",
                        outcome: "Achieved SD for 14 months. Progression marked by development of contralateral lung nodules while on maintenance."
                    }
                },
                { 
                    line: 2, drug: "Osimertinib 80mg", start: "2024-07", end: "Current", resp: "PR", stop: "Ongoing",
                    extended: {
                        rationale: "Transitioned to targeted therapy following identification of EGFR Exon 19 deletion on re-biopsy.",
                        dosing: "Osimertinib 80mg PO Daily.",
                        toxicity: "Grade 1 dry skin and paronychia, managed with topical steroids. Grade 2 diarrhea (intermittent).",
                        outcome: "Deep Partial Response (PR) confirmed on Dec 2024 scans. Primary tumor volume reduced >50%."
                    }
                }
            ],
            Timeline: [
                { 
                    date: "2023-01-15", event: "Initial Presentation", status: "Baseline", cea: 1.8, 
                    detail: "Persistent cough and hemoptysis.",
                    report: {
                        findings: "Patient presented with 3-week history of non-productive cough and trace hemoptysis. ECOG 0. Auscultation reveals diminished breath sounds in RUL.",
                        impression: "Suspicion of pulmonary malignancy vs tuberculosis. CXR confirms opacity.",
                        plan: "Referral to Pulmonology for CT Chest and bronchoscopy."
                    }
                },
                { 
                    date: "2023-03-12", event: "Diagnosis", status: "Baseline", cea: 2.5, 
                    detail: "Initial T2aN1M0. Adeno confirmed.",
                    report: {
                        findings: "CT Chest: 3.2cm spiculated mass RUL. 1.1cm Hilar lymph node. No distant mets. Biopsy: Adenocarcinoma, TTF-1 positive.",
                        impression: "Stage IIIA (T2a N1 M0) NSCLC. Unresectable due to hilar involvement.",
                        plan: "Initiate systemic chemotherapy (Carboplatin/Pemetrexed). Send NGS panel."
                    }
                },
                { 
                    date: "2023-09-20", event: "Interim Scan", status: "SD", cea: 3.1, 
                    detail: "Stable disease on Chemotherapy.",
                    report: {
                        findings: "Primary mass stable at 3.1cm (Prev 3.2cm). Hilar node stable. No new pulmonary nodules. Hepatic parenchyma clear.",
                        impression: "Stable Disease (SD) per RECIST 1.1.",
                        plan: "Continue maintenance Pemetrexed. Monitor renal function."
                    }
                },
                { 
                    date: "2024-05-10", event: "Progression", status: "PD", cea: 12.5, 
                    detail: "New contralateral lung nodules.",
                    report: {
                        findings: "Interval development of 3 new solid nodules in Left Lower Lobe (largest 9mm). Primary RUL mass increased to 4.2cm. Mild pleural effusion.",
                        impression: "Radiological Progression (PD). Conversion to Stage IVA.",
                        plan: "Discontinue Chemo. Re-biopsy for resistance mechanisms. Liquid biopsy sent."
                    }
                },
                { 
                    date: "2024-07-01", event: "Therapy Switch", status: "Baseline", cea: 10.8, 
                    detail: "Initiated Osimertinib.",
                    report: {
                        findings: "NGS confirms EGFR Exon 19 Deletion (Sensitizing). T790M Negative. PD-L1 75%.",
                        impression: "Targetable driver mutation identified. Candidate for 3rd gen TKI.",
                        plan: "Start Osimertinib 80mg QD. Monitor for QTc prolongation and diarrhea."
                    }
                },
                { 
                    date: "2024-12-08", event: "Response Scan", status: "PR", cea: 4.2, 
                    detail: "Primary mass reduced 4.2cm -> 2.1cm.",
                    report: {
                        findings: "Significant interval reduction in RUL mass (4.2cm -> 2.1cm). Contralateral nodules resolved or calcified. Effusion resolved.",
                        impression: "Partial Response (PR). Excellent tolerance to TKI.",
                        plan: "Continue Osimertinib. Next scan in 3 months."
                    }
                }
            ],
            Labs: [
                { name: "AST", val: "58", unit: "U/L", range: "8 - 48", history: [22, 35, 45, 52, 58], trend: "up", status: "abnormal" },
                { name: "ALT", val: "72", unit: "U/L", range: "7 - 55", history: [28, 42, 55, 68, 72], trend: "up", status: "abnormal" },
                { name: "Creatinine", val: "1.0", unit: "mg/dL", range: "0.7 - 1.3", history: [0.9, 1.0, 0.9, 1.0, 1.0], trend: "stable", status: "normal" }
            ],
            AISummary: [
                "Stable metastatic course as of 2025-01-05 visit.",
                "Last imaging (2024-12-08) showed 50% tumor volume reduction (PR).",
                "Today's labs (2025-01-05) show new AST/ALT elevation above ref range.",
                "Longitudinal CEA trend is downward (12.5 -> 4.2) correlating with response.",
                "Molecular profile (EGFR del19) matches current targeted therapy logic.",
                "Performance status stable at ECOG 1 with reported G2 diarrhea."
            ]
        },
        {
            ID: "PT-102", Name: "Arthur Morgan", Dx: "NSCLC (Squamous)", Stage: "IVB", Age: 64, Sex: "M", Line: 1, PS: "ECOG 2",
            History: ["Stable clinical state sustained for 14 months.", "Gradual decline in renal markers identified."],
            EGFR: "Negative", ALK: "Negative", KRAS: "G12C", PDL1: "90%", MSI: "MSS",
            Biology: "Informational: High PD-L1 (90%) is a biological indicator associated with Pembrolizumab response.",
            Treatments: [
                { 
                    line: 1, drug: "Pembrolizumab q3w", start: "2023-01", end: "Current", resp: "SD", stop: "Ongoing",
                    extended: {
                        rationale: "First-line monotherapy indicated for PD-L1 TPS > 50% (Patient 90%) in absence of driver mutations.",
                        dosing: "Pembrolizumab 200mg IV q3w.",
                        toxicity: "Grade 1 hypothyroidism (TSH elevated), started Levothyroxine. No pneumonitis or colitis.",
                        outcome: "Durable Stable Disease (SD). Bone metastases sclerotic. Adrenal lesion stable."
                    }
                }
            ],
            Timeline: [
                { 
                    date: "2022-11-18", event: "Diagnosis", status: "Baseline", cea: 8.0, 
                    detail: "Stage IIIA. Surgery deferred.",
                    report: {
                        findings: "4cm RUL mass abutting mediastinum. N2 disease confirmed via EBUS. Squamous histology.",
                        impression: "Locally advanced NSCLC. Poor surgical candidate due to COPD.",
                        plan: "Refer to Medical Oncology. Molecular testing pending."
                    }
                },
                { 
                    date: "2023-01-05", event: "Metastatic Event", status: "PD", cea: 11.5, 
                    detail: "Bone/Adrenal spread.",
                    report: {
                        findings: "PET Scan: New FDG-avid lesion L3 vertebra (SUV 8.2) and Right Adrenal (3cm).",
                        impression: "Upstaging to IVB. Symptomatic back pain consistent with L3 met.",
                        plan: "Palliative RT to L3. Initiate Pembrolizumab (PD-L1 90%)."
                    }
                },
                { 
                    date: "2023-06-12", event: "Interim Check", status: "SD", cea: 11.0, 
                    detail: "Pain resolved.",
                    report: {
                        findings: "Patient reports resolution of back pain post-RT. ECOG improving to 1. Adrenal met stable.",
                        impression: "Clinical benefit achieved.",
                        plan: "Continue Pembrolizumab. TSH monitoring."
                    }
                },
                { 
                    date: "2024-02-20", event: "Annual Review", status: "SD", cea: 11.8, 
                    detail: "Long-term stability.",
                    report: {
                        findings: "Primary lung mass stable at 3.8cm (cavitary changes). No new bone lesions. Renal function borderline (Cr 1.1).",
                        impression: "Durable SD. Renal decline likely comorbidity related.",
                        plan: "Refer to Nephrology."
                    }
                },
                { 
                    date: "2024-12-18", event: "Recent Review", status: "SD", cea: 12.8, 
                    detail: "Stable thoracic burden.",
                    report: {
                        findings: "Thoracic disease unchanged. Adrenal lesion stable at 2.8cm. L3 sclerosis (healing). No new active lesions.",
                        impression: "Sustained Stable Disease (SD).",
                        plan: "Continue Pembrolizumab. Monitor Creatinine (1.2)."
                    }
                }
            ],
            Labs: [
                { name: "Creatinine", val: "1.2", unit: "mg/dL", range: "0.7 - 1.3", history: [0.9, 1.0, 1.1, 1.1, 1.2], trend: "up", status: "normal" },
                { name: "Hb", val: "9.6", unit: "g/dL", range: "13.5 - 17.5", history: [12.0, 11.2, 10.5, 10.0, 9.6], trend: "down", status: "abnormal" },
                { name: "CEA", val: "12.8", unit: "ng/mL", range: "< 3.0", history: [8.0, 11.5, 10.2, 11.0, 12.8], trend: "stable", status: "abnormal" }
            ],
            AISummary: [
                "Sustained stable disease (SD) on single-agent IO for 23 months.",
                "Declining hemoglobin (12.0 -> 9.6) noted over multiple visits.",
                "Creatinine (1.2) is at upper limit of normal; monitor renal clearance.",
                "CEA trend is plateaued between 11.5 and 12.8 across 2024.",
                "Imaging (2024-12-18) confirms no new bone metastases or growth.",
                "Comorbidity Alert: Uncontrolled T2D may mask clinical cancer symptoms."
            ]
        },
        {
            ID: "PT-103", Name: "Hazel Grace", Dx: "NSCLC (Adeno)", Stage: "IVB", Age: 41, Sex: "F", Line: 2, PS: "ECOG 0",
            History: ["Identified CNS progression Dec 2024.", "Lungs remain radiologically stable."],
            ALK: "Positive", EGFR: "Negative", KRAS: "Negative", PDL1: "10%",
            Biology: "Informational: ALK rearrangement is a biological target for CNS-penetrant TKIs like Alectinib.",
            Treatments: [
                { 
                    line: 1, drug: "Crizotinib", start: "2021-08", end: "2024-02", resp: "PR", stop: "CNS Progression",
                    extended: {
                        rationale: "First-generation ALK inhibitor initiated at diagnosis of metastatic disease.",
                        dosing: "Crizotinib 250mg BID.",
                        toxicity: "Visual disturbances (trails of light) noted initially, resolved. G1 Edema.",
                        outcome: "Good systemic control for 2.5 years. Failure isolated to CNS (brain mets) due to poor BBB penetration."
                    }
                },
                { 
                    line: 2, drug: "Alectinib 600mg BID", start: "2024-03", end: "Current", resp: "PD", stop: "Ongoing",
                    extended: {
                        rationale: "Second-generation ALK TKI chosen for superior CNS penetration following brain relapse.",
                        dosing: "Alectinib 600mg BID with food.",
                        toxicity: "Well tolerated. Mild myalgia (G1) and constipation.",
                        outcome: "Initially cleared CNS disease. Recent breakthrough (Jan 2025) with new cerebellar lesion despite therapy."
                    }
                }
            ],
            Timeline: [
                { 
                    date: "2021-08-04", event: "Diagnosis", status: "Baseline", cea: 1.2, 
                    detail: "Early stage IA adeno.",
                    report: {
                        findings: "Incidental 1.2cm nodule RLL. Resected. ALK+ confirmed on IHC and FISH.",
                        impression: "Stage IA Adenocarcinoma. Margins negative.",
                        plan: "Surveillance. No adjuvant therapy indicated."
                    }
                },
                { 
                    date: "2022-08-04", event: "Surveillance", status: "CR", cea: 1.1, 
                    detail: "One year NED.",
                    report: {
                        findings: "CT Chest/Abd: No evidence of disease. Patient asymptomatic.",
                        impression: "Disease-free interval > 12 months.",
                        plan: "Continue annual surveillance."
                    }
                },
                { 
                    date: "2024-03-01", event: "Recurrence", status: "PD", cea: 3.5, 
                    detail: "Distal lung/brain spread.",
                    report: {
                        findings: "MRI Brain: 2 parietal lesions (1.1cm, 0.9cm) with edema. CT Chest: Multiple miliary nodules.",
                        impression: "Systemic and CNS relapse. Symptomatic (Headache G2).",
                        plan: "Start Alectinib (CNS penetrant). Defer WBRT."
                    }
                },
                { 
                    date: "2024-06-15", event: "Response", status: "PR", cea: 2.1, 
                    detail: "CNS lesions regressed.",
                    report: {
                        findings: "MRI Brain: Parietal lesions reduced to <4mm calcifications. Lung nodules stable/smaller.",
                        impression: "Excellent intracranial response to Alectinib.",
                        plan: "Continue current TKI dosage."
                    }
                },
                { 
                    date: "2025-01-10", event: "Progression", status: "PD", cea: 6.1, 
                    detail: "New 0.8cm brain lesion.",
                    report: {
                        findings: "MRI Brain: New 8mm cerebellar lesion. Previous parietal lesions calcified. Extracranial disease stable.",
                        impression: "Isolated CNS Progression (Oligoprogression).",
                        plan: "Refer for Stereotactic Radiosurgery (SRS). Continue Alectinib."
                    }
                }
            ],
            Labs: [
                { name: "CEA", val: "6.1", unit: "ng/mL", range: "< 3.0", history: [1.2, 1.1, 3.5, 2.1, 6.1], trend: "up", status: "abnormal" },
                { name: "WBC", val: "5.2", unit: "10^3/uL", range: "4.5 - 11.0", history: [4.8, 5.0, 5.1, 5.0, 5.2], trend: "stable", status: "normal" },
                { name: "ALT", val: "28", unit: "U/L", range: "7 - 55", history: [22, 25, 30, 26, 28], trend: "stable", status: "normal" }
            ],
            AISummary: [
                "Recent CNS progression (2025-01-10 MRI) despite L2 systemic control.",
                "CEA trend is upwards (3.5 -> 6.1) since recurrence onset.",
                "Lungs remain stable; progression is isolated to the CNS sanctuary site.",
                "High performance status (ECOG 0) maintained despite new headache symptoms.",
                "Data points to Alectinib resistance in the brain compartment.",
                "Missing: Repeat CSF cytology not performed to date."
            ]
        },
        {
            ID: "PT-104", Name: "Sarah Connor", Dx: "Breast (HER2+)", Stage: "IVB", Age: 48, Sex: "F", Line: 2, PS: "ECOG 1",
            History: ["Hepatic response (PR) confirmed Nov 2024.", "Acute AST/ALT rise after last cycle."],
            HER2: "Positive (3+)", MSI: "MSS", PDL1: "5%",
            Biology: "Informational: HER2 overexpression is associated with sensitivity to HER2-directed antibody-drug conjugates.",
            Treatments: [
                { 
                    line: 1, drug: "THP Regimen", start: "2022-04", end: "2024-04", resp: "SD", stop: "Progression",
                    extended: {
                        rationale: "Standard 1L dual-blockade (Trastuzumab + Pertuzumab) with Taxane for de novo metastatic HER2+ disease.",
                        dosing: "Docetaxel x 6 cycles -> HP Maintenance q3w.",
                        toxicity: "G2 Neuropathy on Taxane (resolved). LVEF maintained >55% on maintenance.",
                        outcome: "Progression in liver after 24 months of control."
                    }
                },
                { 
                    line: 2, drug: "T-DXd (Enhertu)", start: "2024-05", end: "Current", resp: "PR", stop: "Ongoing",
                    extended: {
                        rationale: "Next-generation ADC indicated for HER2+ metastatic breast cancer post-anti-HER2 therapy.",
                        dosing: "Trastuzumab Deruxtecan 5.4 mg/kg q3w.",
                        toxicity: "G2 Nausea (managed with Olanzapine). Recent AST/ALT elevation (Grade 2) under investigation.",
                        outcome: "Robust Partial Response. Metabolic resolution of liver metastases."
                    }
                }
            ],
            Timeline: [
                { 
                    date: "2022-04-15", event: "Diagnosis", status: "Baseline", cea: 5.5, 
                    detail: "Metastatic HER2+ breast.",
                    report: {
                        findings: "Palpable breast mass. CT: Multiple liver mets (Seg IV, V) and L2/L4 bone mets.",
                        impression: "De novo Stage IV HER2+ Breast Cancer.",
                        plan: "Start Taxane + Trastuzumab + Pertuzumab (CLEOPATRA regimen)."
                    }
                },
                { 
                    date: "2022-10-01", event: "Check-in", status: "SD", cea: 4.8, 
                    detail: "Maintenance Phase.",
                    report: {
                        findings: "Chemotherapy (Docetaxel) completed. Liver lesions stable. Alopecia resolving.",
                        impression: "Transitioning to HP maintenance.",
                        plan: "Echo q3 months to monitor LVEF."
                    }
                },
                { 
                    date: "2024-04-20", event: "Progression", status: "PD", cea: 8.5, 
                    detail: "Increased liver burden.",
                    report: {
                        findings: "CT Abdomen: Liver lesions increased in size (2cm -> 3.5cm). New satellite lesions.",
                        impression: "Hepatic progression. Cardiac function normal (LVEF 60%).",
                        plan: "Switch to T-DXd (Enhertu)."
                    }
                },
                { 
                    date: "2024-08-10", event: "Interim Scan", status: "PR", cea: 4.1, 
                    detail: "Good initial response.",
                    report: {
                        findings: "Liver lesions reduced by 30%. Patient reports nausea G2.",
                        impression: "Early Partial Response.",
                        plan: "Add anti-emetics. Continue current dose."
                    }
                },
                { 
                    date: "2024-11-20", event: "Response", status: "PR", cea: 2.1, 
                    detail: "Decreased FDG in liver.",
                    report: {
                        findings: "PET Scan: Complete metabolic resolution of liver lesions. Bone mets sclerotic.",
                        impression: "Deep Partial Response (PR).",
                        plan: "Continue T-DXd. Monitor LFTs closely."
                    }
                }
            ],
            Labs: [
                { name: "AST", val: "110", unit: "U/L", range: "8 - 48", history: [25, 28, 45, 60, 110], trend: "up", status: "abnormal" },
                { name: "ALT", val: "125", unit: "U/L", range: "7 - 55", history: [30, 32, 48, 70, 125], trend: "up", status: "abnormal" },
                { name: "CEA", val: "2.1", unit: "ng/mL", range: "< 3.0", history: [5.5, 4.2, 8.5, 4.0, 2.1], trend: "down", status: "normal" }
            ],
            AISummary: [
                "Partial response (PR) in liver and bone confirmed on 2024-11-20 scans.",
                "Recent labs (2025-01-10) show acute AST/ALT elevation above ref range.",
                "Longitudinal biomarker CA 15-3 dropped from 120 to 45 (last updated Nov).",
                "No new lesions reported since start of Line 2 therapy.",
                "Conflicting data: Robust radiological response vs. worsening hepatic labs.",
                "Missing: Recent Brain MRI to rule out CNS spread."
            ]
        },
        {
            ID: "PT-105", Name: "Sarah Smith", Dx: "Breast (TNBC)", Stage: "IV", Age: 38, Sex: "F", Line: 2, PS: "ECOG 1",
            History: ["Treatment failure on 2L Capecitabine Dec 2024.", "Rapid lung progression detected."],
            MSI: "MSS", PDL1: "2%", TMB: "6", PIK3CA: "Mutant",
            Biology: "Informational: Triple Negative phenotype is associated with high recurrence risk and cytotoxic sensitivity.",
            Treatments: [
                { 
                    line: 1, drug: "AC-T Chemo", start: "2023-01", end: "2024-07", resp: "CR", stop: "Completion",
                    extended: {
                        rationale: "Adjuvant curative-intent chemotherapy for Stage I TNBC.",
                        dosing: "Dose Dense AC x 4 -> Paclitaxel x 4.",
                        toxicity: "Completed as planned. G2 Alopecia, G1 Neuropathy.",
                        outcome: "Clinical CR at completion. Relapsed within 6 months of finishing."
                    }
                },
                { 
                    line: 2, drug: "Capecitabine", start: "2024-08", end: "Current", resp: "PD", stop: "Ongoing",
                    extended: {
                        rationale: "Palliative systemic therapy for metastatic recurrence.",
                        dosing: "Capecitabine 1000mg/m2 BID 14 days on / 7 off.",
                        toxicity: "Hand-Foot Syndrome Grade 2 requiring dose interruption.",
                        outcome: "Primary Refractory. Progression in lungs and liver after only 3 cycles."
                    }
                }
            ],
            Timeline: [
                { 
                    date: "2023-01-20", event: "Diagnosis", status: "Baseline", cea: 1.0, 
                    detail: "Stage IA post-op.",
                    report: {
                        findings: "Lumpectomy bed clean. Nodes 0/14. ER/PR/HER2 Negative.",
                        impression: "Stage IA TNBC.",
                        plan: "Adjuvant AC-T chemotherapy completed."
                    }
                },
                { 
                    date: "2023-09-15", event: "Surveillance", status: "CR", cea: 1.2, 
                    detail: "Post-chemo check.",
                    report: {
                        findings: "Mammogram: negative. Physical exam normal.",
                        impression: "NED.",
                        plan: "Return to clinic in 6 months."
                    }
                },
                { 
                    date: "2024-07-15", event: "Recurrence", status: "PD", cea: 4.5, 
                    detail: "Lung and liver spread.",
                    report: {
                        findings: "CT Chest/Abd: Multiple cannonball lung mets. Liver capsular implants. Biopsy confirms TNBC recurrence.",
                        impression: "Metastatic Recurrence. DFI < 12 months (Platinum resistant?).",
                        plan: "Start Capecitabine. Send ctDNA."
                    }
                },
                { 
                    date: "2024-09-30", event: "Toxicity Check", status: "SD", cea: 5.8, 
                    detail: "Hand-Foot Syndrome.",
                    report: {
                        findings: "Grade 2 Palmar-Plantar Erythrodysesthesia. Painful walking.",
                        impression: "Drug toxicity.",
                        plan: "Dose reduce Capecitabine by 25%. Topical urea cream."
                    }
                },
                { 
                    date: "2024-12-01", event: "Progression", status: "PD", cea: 8.5, 
                    detail: "New lung nodules.",
                    report: {
                        findings: ">20% increase in sum of diameters of lung lesions. New moderate pleural effusion.",
                        impression: "Progression on Capecitabine. PIK3CA mutation detected in liquid biopsy.",
                        plan: "Evaluate for clinical trial or Sacituzumab Govitecan."
                    }
                }
            ],
            Labs: [
                { name: "Hb", val: "10.5", unit: "g/dL", range: "12.0 - 15.5", history: [13.2, 12.8, 11.5, 11.0, 10.5], trend: "down", status: "abnormal" },
                { name: "CA 27-29", val: "88", unit: "U/mL", range: "< 38", history: [15, 18, 45, 60, 88], trend: "up", status: "abnormal" },
                { name: "Albumin", val: "Missing", unit: "g/dL", range: "3.5 - 5.0", history: [], trend: "none", status: "missing" }
            ],
            AISummary: [
                "Highly aggressive course post-adjuvant chemotherapy completion.",
                "Radiological failure on 2L Capecitabine within 4 months (2024-12-01 scan).",
                "CA 27-29 trend spiked from 15 to 88 over the course of 2024.",
                "PIK3CA mutation identified in ctDNA Dec 2024 may have clinical relevance.",
                "Ambiguity: Pathology shows TNBC phenotype but lobular features on biopsy.",
                "Missing: Recent Albumin and Full Metabolic Panel for nutritional review."
            ]
        },
        {
            ID: "PT-106", Name: "Walter White", Dx: "Colorectal (KRAS+)", Stage: "IV", Age: 55, Sex: "M", Line: 1, PS: "ECOG 1",
            History: ["Maintenance stability for 18 months.", "Pending current quarter CT imaging results."],
            KRAS: "G12V", MSI: "MSS", PDL1: "0%", BRAF: "Negative",
            Biology: "Informational: KRAS mutations are associated with intrinsic resistance to anti-EGFR therapies.",
            Treatments: [
                { 
                    line: 1, drug: "FOLFOX + Bev", start: "2023-06", end: "Current", resp: "SD", stop: "Ongoing",
                    extended: {
                        rationale: "Standard 1L doublet + VEGF inhibitor for RAS-mutant mCRC.",
                        dosing: "mFOLFOX6 + Bevacizumab 5mg/kg q2w. Oxaliplatin dropped after cycle 8.",
                        toxicity: "Oxaliplatin-induced neuropathy (Grade 2) persisting in fingertips. HTN controlled on meds.",
                        outcome: "Stable Disease. Currently on 5-FU/Bevacizumab maintenance phase."
                    }
                }
            ],
            Timeline: [
                { 
                    date: "2023-05-10", event: "Diagnosis", status: "Baseline", cea: 12.0, 
                    detail: "Stage IIIB Sigmoid CRC.",
                    report: {
                        findings: "Obstructing sigmoid mass. Urgent Hemicolectomy. 4/15 lymph nodes positive.",
                        impression: "Stage IIIB Adenocarcinoma.",
                        plan: "Adjuvant FOLFOX planned."
                    }
                },
                { 
                    date: "2023-06-01", event: "Metastasis", status: "PD", cea: 18.2, 
                    detail: "Liver met identified.",
                    report: {
                        findings: "Baseline staging CT reveals 2 hypodense lesions in liver Seg VI/VII, confirmed MRI.",
                        impression: "Synchronous Metastatic Disease (Stage IV). KRAS G12V detected.",
                        plan: "Convert to Palliative FOLFOX + Bevacizumab."
                    }
                },
                { 
                    date: "2023-11-20", event: "Maintenance", status: "SD", cea: 9.5, 
                    detail: "Oxaliplatin hold.",
                    report: {
                        findings: "Peripheral neuropathy G2 (buttoning shirts difficult). Liver lesions stable/calcified.",
                        impression: "Treatment limiting toxicity.",
                        plan: "Drop Oxaliplatin. Continue 5-FU/Leucovorin/Avastin."
                    }
                },
                { 
                    date: "2024-06-20", event: "Stable", status: "SD", cea: 15.0, 
                    detail: "No change.",
                    report: {
                        findings: "Disease stable. CEA slowly creeping but imaging stable.",
                        impression: "Maintenance effective.",
                        plan: "Continue current regimen."
                    }
                },
                { 
                    date: "2025-01-02", event: "Review", status: "SD", cea: 15.4, 
                    detail: "Scans overdue/pending.",
                    report: {
                        findings: "Physical exam unremarkable. Neuropathy G2 (fingertips). CEA stable at 15.4.",
                        impression: "Clinically stable. Neuropathy worsening.",
                        plan: "Hold Oxaliplatin. Continue 5-FU/Bev maintenance. Chase CT scan results."
                    }
                }
            ],
            Labs: [
                { name: "CEA", val: "15.4", unit: "ng/mL", range: "< 3.0", history: [12, 18.2, 8.5, 15.0, 15.4], trend: "stable", status: "abnormal" },
                { name: "Plt", val: "180", unit: "10^3/uL", range: "150 - 450", history: [210, 200, 195, 185, 180], trend: "down", status: "normal" },
                { name: "AST", val: "32", unit: "U/L", range: "8 - 48", history: [30, 28, 31, 30, 32], trend: "stable", status: "normal" }
            ],
            AISummary: [
                "Long-term stability (18mo) on 1L cytotoxic maintenance regimen.",
                "CEA markers plateaued at 15.0 - 15.4 ng/mL since Jan 2024.",
                "Patient reports progressive G2 neuropathy as of Jan 2025.",
                "Uncertainty: Decision support limited by overdue CT Chest/Abdomen (Pending).",
                "No clinical evidence of bowel obstruction or new systemic symptoms.",
                "Molecular logic confirms exclusion of anti-EGFR therapy due to KRAS G12V."
            ]
        },
        {
            ID: "PT-107", Name: "Jesse Pinkman", Dx: "Colorectal (MSI-H)", Stage: "NED", Age: 32, Sex: "M", Line: 1, PS: "ECOG 0",
            History: ["Complete radiological resolution Jun 2024.", "Sustained NED status as of Jan 2025."],
            MSI: "MSI-H", TMB: "45", KRAS: "Wild Type",
            Biology: "Informational: MSI-High and high TMB are biological drivers associated with exceptional IO response.",
            Treatments: [
                { 
                    line: 1, drug: "Pembrolizumab", start: "2023-12", end: "Current", resp: "CR", stop: "Ongoing",
                    extended: {
                        rationale: "Frontline immunotherapy (Keynote-177) for MSI-High mCRC.",
                        dosing: "Pembrolizumab 200mg IV q3w.",
                        toxicity: "Excellent tolerance. No immune-mediated adverse events (Grade 0).",
                        outcome: "Complete Radiological Response confirmed June 2024. Sustained NED."
                    }
                }
            ],
            Timeline: [
                { 
                    date: "2023-11-05", event: "Diagnosis", status: "Baseline", cea: 12.0, 
                    detail: "Stage IV peritoneal spread.",
                    report: {
                        findings: "Young onset. Extensive peritoneal carcinomatosis. Primary Right Colon. IHC: MLH1/PMS2 Absent.",
                        impression: "dMMR/MSI-High Metastatic CRC.",
                        plan: "Start Pembrolizumab (Keynote-177 protocol)."
                    }
                },
                { 
                    date: "2024-02-14", event: "Initial Response", status: "PR", cea: 4.5, 
                    detail: "Symptom relief.",
                    report: {
                        findings: "Abdominal pain resolved. CT: Significant regression of peritoneal omental cake.",
                        impression: "Partial Response.",
                        plan: "Continue therapy. Monitor for colitis."
                    }
                },
                { 
                    date: "2024-06-20", event: "Interval Scan", status: "CR", cea: 1.8, 
                    detail: "Resolution of disease.",
                    report: {
                        findings: "CT Chest/Abd/Pelvis: Complete resolution of peritoneal implants. Normalization of bowel wall thickening.",
                        impression: "Complete Radiological Response (CR).",
                        plan: "Continue Pembrolizumab for 2 years total."
                    }
                },
                { 
                    date: "2024-12-10", event: "Surveillance", status: "CR", cea: 1.4, 
                    detail: "Year 1 milestone.",
                    report: {
                        findings: "No new complaints. Imaging remains clear.",
                        impression: "Sustained NED.",
                        plan: "Continue."
                    }
                },
                { 
                    date: "2025-01-09", event: "Latest Scan", status: "CR", cea: 1.2, 
                    detail: "NED sustained.",
                    report: {
                        findings: "PET/CT: No hypermetabolic activity. CEA 1.2.",
                        impression: "Sustained Complete Response (NED).",
                        plan: "Surveillance. Discuss treatment break."
                    }
                }
            ],
            Labs: [
                { name: "CEA", val: "1.2", unit: "ng/mL", range: "< 3.0", history: [12, 4.5, 1.8, 1.5, 1.2], trend: "down", status: "normal" },
                { name: "WBC", val: "7.2", unit: "10^3/uL", range: "4.5 - 11.0", history: [6.8, 6.5, 7.0, 7.1, 7.2], trend: "stable", status: "normal" },
                { name: "Cr", val: "0.8", unit: "mg/dL", range: "0.7 - 1.3", history: [0.8, 0.8, 0.9, 0.8, 0.8], trend: "stable", status: "normal" }
            ],
            AISummary: [
                "Patient in deep sustained complete response (CR) since Jun 2024.",
                "CEA normalized (12.0 -> 1.2) within first 3 months of therapy.",
                "Latest PET/CT (2025-01-09) confirms zero metabolic activity.",
                "No reported immunotherapy-related adverse events (irAEs) to date.",
                "Clinical status is optimal (ECOG 0) with no symptomatic disease.",
                "Current management is transitioning to surveillance-only focus."
            ]
        },
        {
            ID: "PT-108", Name: "Skyler White", Dx: "NSCLC (Stage I)", Stage: "IA", Age: 42, Sex: "F", Line: 0, PS: "ECOG 1",
            History: ["Post-op curative resection June 2024.", "Surveillance baseline established."],
            EGFR: "Negative", ALK: "Negative", KRAS: "Negative",
            Biology: "Informational: Early stage disease (T1) without drivers has a favorable surgical prognosis.",
            Treatments: [
                { 
                    line: 0, drug: "RML Lobectomy", start: "2024-06", end: "2024-06", resp: "CR", stop: "Completion",
                    extended: {
                        rationale: "Definitive surgical management for Stage IA NSCLC.",
                        dosing: "VATS Right Middle Lobectomy.",
                        toxicity: "Post-operative atelectasis (resolved). Chronic mild intercostal neuralgia.",
                        outcome: "R0 Resection (Negative Margins). No adjuvant therapy required."
                    }
                }
            ],
            Timeline: [
                { 
                    date: "2024-05-20", event: "Screening", status: "Baseline", cea: 0.9, 
                    detail: "Suspicious nodule.",
                    report: {
                        findings: "LDCT Screening: 1.8cm RML nodule. PET avid. Brain MRI negative.",
                        impression: "Clinical Stage IA NSCLC.",
                        plan: "VATS RML Lobectomy."
                    }
                },
                { 
                    date: "2024-06-10", event: "Diagnosis", status: "Baseline", cea: 0.9, 
                    detail: "Biopsy confirmation.",
                    report: {
                        findings: "TTF-1 Positive Adenocarcinoma.",
                        impression: "Confirmed malignancy.",
                        plan: "Proceed to surgery."
                    }
                },
                { 
                    date: "2024-06-25", event: "Surgery", status: "CR", cea: 0.8, 
                    detail: "Lobectomy complete.",
                    report: {
                        findings: "RML Lobectomy + Node dissection. Margins negative. Path: Adenocarcinoma, minimally invasive.",
                        impression: "Surgical Cure.",
                        plan: "Post-op recovery."
                    }
                },
                { 
                    date: "2024-11-05", event: "Post-op CT", status: "CR", cea: 0.8, 
                    detail: "Clean surgical bed.",
                    report: {
                        findings: "Post-surgical changes RML. No nodules. No lymphadenopathy.",
                        impression: "No Evidence of Disease (NED).",
                        plan: "Next surveillance CT in 6 months."
                    }
                },
                { 
                    date: "2024-12-15", event: "Follow-up", status: "SD", cea: 0.8, 
                    detail: "Recovering well.",
                    report: {
                        findings: "Breath sounds clear. Incision healed. Mild post-op fatigue.",
                        impression: "Recovery uncomplicated.",
                        plan: "Continue pulm rehab exercises."
                    }
                }
            ],
            Labs: [
                { name: "CEA", val: "0.8", unit: "ng/mL", range: "< 3.0", history: [0.9, 0.9, 0.8, 0.8, 0.8], trend: "stable", status: "normal" },
                { name: "Hb", val: "12.0", unit: "g/dL", range: "12.0 - 15.5", history: [13.5, 12.8, 12.2, 12.1, 12.0], trend: "stable", status: "normal" },
                { name: "WBC", val: "Missing", unit: "10^3/uL", range: "4.5 - 11.0", history: [], trend: "none", status: "missing" }
            ],
            AISummary: [
                "Curative-intent surgery completed with negative margins Jun 2024.",
                "Surveillance CT (2024-11-05) shows no evidence of recurrence.",
                "CEA remains at baseline floor levels (< 1.0) post-resection.",
                "No clinical signs of pulmonary distress or recurrence reported.",
                "Missing: Latest WBC and electrolyte panel since surgery.",
                "Patient reports post-surgical fatigue only; ECOG 1 functional."
            ]
        },
        {
            ID: "PT-109", Name: "Gustavo Fring", Dx: "Colorectal (Adeno)", Stage: "IVB", Age: 60, Sex: "M", Line: 2, PS: "ECOG 2",
            History: ["Critical CEA spike from 40 to 245 since Sep 2024.", "New bone lesions identified on 2025-01-04 imaging."],
            BRAF: "V600E", KRAS: "WT", MSI: "MSS", PDL1: "15%",
            Biology: "Informational: BRAF V600E mutations are associated with aggressive disease and rapid progression.",
            Treatments: [
                { 
                    line: 1, drug: "FOLFOX", start: "2023-02", end: "2024-09", resp: "PD", stop: "Progression",
                    extended: {
                        rationale: "Adjuvant therapy turned palliative upon recurrence.",
                        dosing: "mFOLFOX6 q2w.",
                        toxicity: "Grade 3 Neutropenia requiring G-CSF. G2 Fatigue.",
                        outcome: "Disease progression in liver and lungs."
                    }
                },
                { 
                    line: 2, drug: "Encorafenib + Cetux", start: "2024-10", end: "Current", resp: "PD", stop: "Radiological Failure",
                    extended: {
                        rationale: "BEACON regimen: Standard 2L for BRAF V600E mutant mCRC.",
                        dosing: "Encorafenib 300mg QD + Cetuximab 500mg/m2 q2w.",
                        toxicity: "Acneiform rash Grade 3 (Cetuximab effect). Arthralgia.",
                        outcome: "Rapid failure. Explosive CEA rise and new bone metastases."
                    }
                }
            ],
            Timeline: [
                { 
                    date: "2023-02-14", event: "Diagnosis", status: "Baseline", cea: 5.0, 
                    detail: "Stage IIIB. High CEA.",
                    report: {
                        findings: "Colonoscopy: Obstructing mass. BRAF V600E confirmed.",
                        impression: "BRAF-mutant Colon Cancer.",
                        plan: "Surgery followed by adjuvant chemo."
                    }
                },
                { 
                    date: "2023-11-10", event: "Relapse", status: "PD", cea: 25.0, 
                    detail: "Peritoneal spread.",
                    report: {
                        findings: "Recurrence in peritoneum. Started FOLFOX.",
                        impression: "Metastatic Relapse.",
                        plan: "Palliative Chemotherapy."
                    }
                },
                { 
                    date: "2024-09-15", event: "1L Failure", status: "PD", cea: 40.0, 
                    detail: "Lung/Liver progression.",
                    report: {
                        findings: "CT: Multiple liver metastases and bilateral lung nodules. CEA rose 5 -> 40.",
                        impression: "Metastatic Recurrence. 1L Failure.",
                        plan: "Switch to Targeted Doublet (Encorafenib/Cetuximab)."
                    }
                },
                { 
                    date: "2024-11-20", event: "Mixed Resp", status: "SD", cea: 110.0, 
                    detail: "No regression.",
                    report: {
                        findings: "Primary refractory disease. CEA doubling time < 4 weeks. Rash G3.",
                        impression: "Early Signs of Resistance.",
                        plan: "Continue but monitor closely."
                    }
                },
                { 
                    date: "2025-01-04", event: "2L Failure", status: "PD", cea: 245.0, 
                    detail: "CEA spiked to 245. Bone mets.",
                    report: {
                        findings: "Bone Scan: Diffuse uptake in lumbar spine/pelvis. CEA 245. Cr 1.4.",
                        impression: "Rapid clinical decline. 2L Failure.",
                        plan: "Hospice referral / Best Supportive Care discussion."
                    }
                }
            ],
            Labs: [
                { name: "CEA", val: "245", unit: "ng/mL", range: "< 3.0", history: [5, 25, 40, 110, 245], trend: "up", status: "abnormal" },
                { name: "Creatinine", val: "1.4", unit: "mg/dL", range: "0.7 - 1.3", history: [0.8, 0.9, 1.1, 1.3, 1.4], trend: "up", status: "abnormal" },
                { name: "Hb", val: "9.2", unit: "g/dL", range: "13.5 - 17.5", history: [12, 11, 10.5, 9.8, 9.2], trend: "down", status: "abnormal" }
            ],
            AISummary: [
                "Rapid multi-organ progression failing current 2L targeted therapy.",
                "Exponential CEA spike (40 -> 245) noted over the last quarter.",
                "Radiological failure (2025-01-04) confirmed with new skeletal involvement.",
                "Declining renal function (Cr 1.4) correlates with overall physical decline.",
                "Anemia is worsening (Hb 9.2), potentially contributing to ECOG 2 status.",
                "Uncertainty: Disease burden outpaces current therapeutic efficacy."
            ]
        },
        {
            ID: "PT-110", Name: "Hank Schrader", Dx: "Breast (Male ER+)", Stage: "IV", Age: 54, Sex: "M", Line: 1, PS: "ECOG 1",
            History: ["Stable bone lesions on Tamoxifen.", "Hormone receptor status high (ER 95%)."],
            ER: "95%", PR: "80%", HER2: "Negative", MSI: "MSS",
            Biology: "Informational: High ER/PR expression in male breast cancer is associated with hormone-therapy response.",
            Treatments: [
                { 
                    line: 1, drug: "Tamoxifen 20mg", start: "2024-03", end: "Current", resp: "SD", stop: "Ongoing",
                    extended: {
                        rationale: "Standard hormonal therapy for ER+ Male Breast Cancer.",
                        dosing: "Tamoxifen 20mg PO Daily.",
                        toxicity: "Hot flashes (Grade 1). Weight gain (3kg).",
                        outcome: "Stable Disease. Bone lesions controlled with concurrent RT."
                    }
                }
            ],
            Timeline: [
                { 
                    date: "2024-02-10", event: "Diagnosis", status: "Baseline", cea: 2.2, 
                    detail: "Stage IIB post-op.",
                    report: {
                        findings: "Left Mastectomy. 2.5cm IDC. 1/14 nodes. ER 95% PR 80%.",
                        impression: "Male Breast Cancer. Luminal A.",
                        plan: "Start Tamoxifen."
                    }
                },
                { 
                    date: "2024-06-15", event: "Routine Check", status: "SD", cea: 2.3, 
                    detail: "Asymptomatic.",
                    report: {
                        findings: "Well healed scar. No nodes palpable.",
                        impression: "Doing well.",
                        plan: "Continue Tamoxifen."
                    }
                },
                { 
                    date: "2024-10-15", event: "Metastasis", status: "PD", cea: 3.2, 
                    detail: "PET: Rib involvement.",
                    report: {
                        findings: "Patient reported rib pain. Bone scan: Solitary uptake Left 5th rib. No visceral disease.",
                        impression: "Oligometastatic Bone Disease.",
                        plan: "Palliative RT (8Gy/1fx). Continue Tamoxifen."
                    }
                },
                { 
                    date: "2024-12-01", event: "Palliation", status: "SD", cea: 3.4, 
                    detail: "Radiation complete.",
                    report: {
                        findings: "RT course completed. Pain improving.",
                        impression: "Post-RT check.",
                        plan: "Monitor."
                    }
                },
                { 
                    date: "2025-01-03", event: "Follow-up", status: "SD", cea: 3.5, 
                    detail: "Bone lesion stable.",
                    report: {
                        findings: "Pain resolved (0/10). No new complaints. PSA 1.2 (Normal).",
                        impression: "Clinically stable.",
                        plan: "Continue current management."
                    }
                }
            ],
            Labs: [
                { name: "CEA", val: "3.5", unit: "ng/mL", range: "< 3.0", history: [2.2, 2.1, 3.2, 3.4, 3.5], trend: "stable", status: "normal" },
                { name: "Hb", val: "12.8", unit: "g/dL", range: "13.5 - 17.5", history: [14.0, 13.8, 13.5, 13.0, 12.8], trend: "stable", status: "normal" },
                { name: "PSA", val: "1.2", unit: "ng/mL", range: "< 4.0", history: [1.1, 1.1, 1.2, 1.2, 1.2], trend: "stable", status: "normal" }
            ],
            AISummary: [
                "Clinically stable male breast cancer on 1L hormone therapy.",
                "Isolated rib lesion (Oct 2024) remains metabolic-quiescent on last PET.",
                "CEA markers remain within clinical tolerance levels (~3.5).",
                "Strong ER expression (95%) matches current Tamoxifen sensitivity profile.",
                "Patient reports manageable hot flashes as a side effect of therapy.",
                "Imaging confirms no visceral or symptomatic progression today."
            ]
        }
    ];
    
        let selectedPt = PATIENTS[0];
        let charts = [];

        function loadPatient() {
            const selector = document.getElementById('patientSelect');
            selectedPt = PATIENTS.find(p => p.ID === selector.value);
            renderDashboard();
        }

        function renderDashboard() {
            clearCharts();
            renderHeader();
            renderTimeline();
            renderTreatments();
            renderLabs();
            renderAISummary();
            renderMolecular();
            lucide.createIcons();
        }

        function renderHeader() {
            // 1. Render the Top Summary Card (Now with Patient Name)
            const header = document.getElementById('topSummary');
            header.innerHTML = `
                <div>
                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Patient</span>
                    <span class="text-sm font-bold text-indigo-900">${selectedPt.Name}</span>
                    <span class="text-xs text-slate-400 font-medium ml-1">(${selectedPt.ID})</span>
                </div>
                <div><span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Status</span><span class="text-sm font-bold text-slate-800">${selectedPt.Age}Y | ${selectedPt.Sex}</span></div>
                <div><span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Diagnosis</span><span class="text-sm font-bold text-indigo-700">${selectedPt.Dx}</span></div>
                <div><span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Current Stage</span><span class="text-sm font-bold text-slate-800">Stage ${selectedPt.Stage}</span></div>
                <div><span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Active Arc</span><span class="text-sm font-bold text-slate-800">Line ${selectedPt.Line}</span></div>
                <div><span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Functional</span><span class="text-sm font-bold text-emerald-600">${selectedPt.PS}</span></div>
            `;

            // 2. Render the Clinical Changes (The Purple Box)
            const updatesBox = document.getElementById('clinicalUpdates');
            if(updatesBox) {
                updatesBox.innerHTML = `
                    <h3 class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-2">Key Clinical Changes</h3>
                    <div class="space-y-1">
                        ${selectedPt.History.map(h => `<div class="text-sm font-bold text-indigo-900"> ${h}</div>`).join('')}
                    </div>
                `;
            }
        }

        // 1. Updated Timeline Renderer (Clickable)
        function renderTimeline() {
            const list = document.getElementById('timelineContainer');
            list.innerHTML = `<div class="timeline-line"></div>`;
            
            selectedPt.Timeline.forEach((t, i) => {
                const item = document.createElement('div');
                // Added cursor-pointer and hover effects
                item.className = "relative pl-10 pb-6 group cursor-pointer transition-all duration-200 hover:translate-x-1";
                item.onclick = () => openModal(t); // Trigger modal on click
                
                item.innerHTML = `
                    <div class="timeline-dot ${i === selectedPt.Timeline.length - 1 ? 'active shadow-[0_0_0_4px_#e0e7ff]' : 'group-hover:border-indigo-500 group-hover:bg-indigo-50'} absolute left-0 top-1 transition-colors"></div>
                    
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-tight group-hover:text-indigo-600">${t.date}</span>
                        <span class="status-badge bg-${t.status.toLowerCase()}">${t.status}</span>
                    </div>
                    <div class="text-xs font-bold text-slate-800 group-hover:text-indigo-700">${t.event} <span class="text-[10px] text-indigo-400 opacity-0 group-hover:opacity-100 ml-1">(View Report)</span></div>
                    <div class="text-[10px] text-slate-400 mt-1 leading-relaxed line-clamp-2">${t.detail}</div>
                `;
                list.appendChild(item);
            });
            renderBiomarkerChart();
        }

        // 2. Updated "Sexy" Chart Renderer
        function renderBiomarkerChart() {
            const canvas = document.getElementById('biomarkerChart');
            const ctx = canvas.getContext('2d');
            
            // Create a gradient for the "sexy" look
            let gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(79, 70, 229, 0.2)'); // Indigo-500 at top
            gradient.addColorStop(1, 'rgba(79, 70, 229, 0.0)'); // Transparent at bottom

            const plotData = selectedPt.Timeline.filter(t => t.cea !== undefined);
            
            // Determine the Y-Axis Label based on the patient's marker type (heuristic based on first key)
            // For this dataset we mostly use "CEA", but let's make it look dynamic
            const yLabel = selectedPt.Dx.includes("Prostate") || selectedPt.Labs.some(l=>l.name==="PSA") ? "PSA (ng/mL)" : 
                           selectedPt.Dx.includes("Breast") ? "CA 15-3 / CEA" : "Biomarker Level (ng/mL)";

            charts.push(new Chart(ctx, {
                type: 'line',
                data: {
                    labels: plotData.map(t => t.date),
                    datasets: [{
                        label: yLabel,
                        data: plotData.map(t => t.cea),
                        borderColor: '#4f46e5',
                        backgroundColor: gradient, // Use gradient
                        borderWidth: 2.5,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#4f46e5',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: true, // Fill area under line
                        tension: 0.4 // Smooth curves ("Sexy")
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: { 
                        legend: { display: true, position: 'top', align: 'end', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.9)',
                            padding: 10,
                            titleFont: { size: 11, weight: 'bold' },
                            bodyFont: { size: 11 }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { color: '#f1f3f5', borderDash: [5, 5] }, 
                            ticks: { font: { size: 10, weight: '600' }, color: '#64748b' },
                            title: { display: true, text: yLabel, font: { size: 10, weight: 'bold' }, color: '#94a3b8' } // Y-Axis Label
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { font: { size: 9, weight: '600' }, color: '#64748b', maxRotation: 45, minRotation: 45 } 
                        }
                    }
                }
            }));
        }

        // 3. Modal Logic
        // 3. Updated Sidebar Logic (Slide-over)
        function openModal(data) {
            // Populate Header
            document.getElementById('sidebarDate').innerText = data.date;
            document.getElementById('sidebarEvent').innerText = data.event;
            
            // Populate Badge
            const badge = document.getElementById('sidebarBadge');
            badge.className = `status-badge bg-${data.status.toLowerCase()} px-3 py-1 text-xs`;
            badge.innerText = data.status;

            // Populate Content Areas (Checking for structured data vs legacy string)
            const container = document.getElementById('sidebarContent');
            
            if (data.report) {
                // RENDER STRUCTURED REPORT (The "Sexy" Detailed View)
                container.innerHTML = `
                    <div class="space-y-2">
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">Findings / Clinical Context</h4>
                        <p class="text-sm text-slate-700 leading-relaxed font-medium">${data.report.findings}</p>
                    </div>

                    <div class="space-y-2">
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">Impression</h4>
                        <p class="text-sm text-slate-700 leading-relaxed font-medium bg-indigo-50/50 p-3 rounded border-l-2 border-indigo-400">${data.report.impression}</p>
                    </div>

                    <div class="space-y-2">
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 pb-1">Plan / Next Steps</h4>
                        <p class="text-sm text-slate-700 leading-relaxed font-medium">${data.report.plan}</p>
                    </div>
                `;
            } else {
                // Fallback if data is missing
                container.innerHTML = `<p class="text-sm text-slate-500 italic">No structured report available for this historical entry.</p>`;
            }

            // Show Sidebar (Animation classes)
            const sidebar = document.getElementById('eventSidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            
            backdrop.classList.remove('hidden');
            // Small delay to allow display:block to apply before changing opacity for fade effect
            setTimeout(() => backdrop.classList.remove('opacity-0'), 10);
            
            sidebar.classList.remove('translate-x-full');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('eventSidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            
            sidebar.classList.add('translate-x-full');
            backdrop.classList.add('opacity-0');
            
            setTimeout(() => backdrop.classList.add('hidden'), 300);
        }
       
       // HELPER: Toggles the visibility of treatment details
        function toggleTreatment(index) {
            const content = document.getElementById(`tx-detail-${index}`);
            const icon = document.getElementById(`tx-icon-${index}`);
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // HELPER: Calculates duration in months between two dates (YYYY-MM)
        function getDuration(start, end) {
            const startDate = new Date(start + "-01");
            const endDate = end === "Current" ? new Date() : new Date(end + "-01");
            
            let months = (endDate.getFullYear() - startDate.getFullYear()) * 12;
            months -= startDate.getMonth();
            months += endDate.getMonth();
            
            // Correction for partial months/inclusive calculation
            months = months <= 0 ? 0 : months; 
            
            return `${months} months`;
        }

        // UPDATED: Render Treatments as Clinical Courses
        function renderTreatments() {
            const container = document.getElementById('treatmentLines');
            container.innerHTML = "";
            
            selectedPt.Treatments.forEach((t, index) => {
                // 1. Determine Visual Theme
                let theme = { border: 'border-slate-200', bg: 'bg-slate-50', text: 'text-slate-600', badge: 'bg-slate-100 text-slate-600' };
                const stopReason = t.stop.toLowerCase();
                const response = t.resp.toLowerCase();

                if (stopReason.includes('ongoing')) {
                    theme = { border: 'border-emerald-500', bg: 'bg-emerald-50', text: 'text-emerald-700', badge: 'bg-emerald-100 text-emerald-800' };
                } else if (stopReason.includes('progression') || stopReason.includes('failure')) {
                    theme = { border: 'border-red-400', bg: 'bg-red-50', text: 'text-red-700', badge: 'bg-red-100 text-red-800' };
                } else if (stopReason.includes('toxicity')) {
                    theme = { border: 'border-amber-400', bg: 'bg-amber-50', text: 'text-amber-700', badge: 'bg-amber-100 text-amber-800' };
                } else if (response === 'cr' || response === 'pr') {
                    theme = { border: 'border-indigo-300', bg: 'bg-indigo-50', text: 'text-indigo-700', badge: 'bg-indigo-100 text-indigo-800' };
                }

                // 2. Render Accordion
                container.innerHTML += `
                    <div class="mb-4 rounded border border-slate-200 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                        
                        <div onclick="toggleTreatment(${index})" class="relative flex flex-col md:flex-row gap-4 p-4 cursor-pointer bg-white hover:bg-slate-50/50 border-l-4 ${theme.border} transition-colors">
                            
                            <div class="flex flex-col items-center justify-center shrink-0 md:border-r border-slate-100 md:pr-4 min-w-[60px]">
                                <span class="text-[9px] font-black uppercase tracking-widest text-slate-400 mb-1">Line</span>
                                <div class="text-xl font-black ${theme.text}">${t.line}</div>
                            </div>

                            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                                <div>
                                    <h4 class="text-sm font-bold text-slate-900 flex items-center gap-2">
                                        ${t.drug}
                                        ${t.end === "Current" ? '<span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-emerald-100 text-emerald-700 uppercase tracking-wide">Active</span>' : ''}
                                    </h4>
                                    <div class="flex items-center gap-2 mt-1 text-[11px] font-medium text-slate-500">
                                        <span>${t.start}  ${t.end}</span>
                                        <span class="text-slate-300">|</span>
                                        <span class="text-slate-700 font-semibold">${getDuration(t.start, t.end)}</span>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between md:justify-end md:gap-8">
                                    <div>
                                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider block mb-0.5">Response</span>
                                        <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold border border-slate-100 bg-white text-slate-700">${t.resp}</span>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider block mb-0.5">Outcome</span>
                                        <span class="text-[11px] font-bold ${theme.text}">${t.stop}</span>
                                    </div>
                                    <i id="tx-icon-${index}" data-lucide="chevron-down" class="w-5 h-5 text-slate-300 transition-transform duration-300"></i>
                                </div>
                            </div>
                        </div>

                        <div id="tx-detail-${index}" class="hidden bg-slate-50 border-t border-slate-100 p-5 animate-[fadeIn_0.2s_ease-out]">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                
                                <div>
                                    <h5 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 border-b border-slate-200 pb-1">Context & Rationale</h5>
                                    <p class="text-xs font-medium text-slate-700 leading-relaxed">
                                        ${t.extended.rationale}
                                    </p>
                                    <div class="mt-3">
                                        <span class="text-[9px] font-bold text-slate-400 uppercase">Dosing Regimen:</span>
                                        <p class="text-xs text-slate-600 font-mono mt-0.5">${t.extended.dosing}</p>
                                    </div>
                                </div>

                                <div>
                                    <h5 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 border-b border-slate-200 pb-1">Safety Profile</h5>
                                    <p class="text-xs font-medium text-slate-700 leading-relaxed">
                                        ${t.extended.toxicity}
                                    </p>
                                </div>

                                <div>
                                    <h5 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 border-b border-slate-200 pb-1">Clinical Outcome</h5>
                                    <div class="bg-white p-3 rounded border border-slate-200">
                                        <p class="text-xs font-bold text-slate-800 leading-relaxed">
                                            ${t.extended.outcome}
                                        </p>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                `;
            });
            lucide.createIcons();
        }

       // HELPER: Parse range string (e.g. "8 - 48") to numbers
        function parseRange(rangeStr) {
            if (!rangeStr || rangeStr.toLowerCase() === 'missing') return null;
            // Remove < or > signs for simple parsing, though ideally handle them
            const clean = rangeStr.replace(/[<>]/g, ''); 
            if (clean.includes('-')) {
                const parts = clean.split('-').map(s => parseFloat(s.trim()));
                return { min: parts[0], max: parts[1] };
            }
            if (rangeStr.includes('<')) return { min: 0, max: parseFloat(clean) };
            return null;
        }

        let labChartInstance = null; // Store chart instance to destroy it later

        // HELPER: Parse range string (e.g. "8 - 48" or "< 3.0")
        function parseRange(rangeStr) {
            if (!rangeStr || rangeStr.toLowerCase() === 'missing') return null;
            const clean = rangeStr.replace(/[<>]/g, ''); 
            if (clean.includes('-')) {
                const parts = clean.split('-').map(s => parseFloat(s.trim()));
                return { min: parts[0], max: parts[1] };
            }
            // If "< 3.0", min is 0, max is 3.0
            if (rangeStr.includes('<')) return { min: 0, max: parseFloat(clean) };
            return null;
        }

        let sidebarChartInstance = null;

        function renderLabs() {
            const container = document.getElementById('labsGrid');
            container.innerHTML = ""; 
            // Change container to a grid layout for "Sideways" view of categories
            container.className = "grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-8"; 

            // 1. Safety Context Banner (Subtle, top of section)
            // We prepend this outside the grid logic or insert it before calling renderLabs in the HTML
            // But let's add it dynamically to the section header if possible, or just putting it here:
            // (Actually, the user asked for context text. Let's append a full-width header first)
            
            // NOTE: Since the container is now a grid, we need to clear previous content slightly differently 
            // or put the header outside. Let's do this:
            
            // To make the layout work with the grid, we will attach the header to the section title in HTML usually, 
            // but here we can't touch HTML outside. We will just render the grid items.
            
            // 2. Define Clinical Categories
            const categories = {
                'Hematology': ['Hb', 'WBC', 'Plt', 'Platelets', 'Neutrophils', 'Lymphocytes', 'Hgb'],
                'Liver Function': ['AST', 'ALT', 'Bilirubin', 'Albumin', 'ALP'],
                'Renal & Metabolic': ['Creatinine', 'Cr', 'eGFR', 'Sodium', 'Potassium', 'Electrolytes'],
                'Tumor Markers': ['CEA', 'PSA', 'CA 15-3', 'CA 27-29', 'CA 125', 'AFP']
            };

            // 3. Process Each Category
            Object.entries(categories).forEach(([catName, keywords]) => {
                // Find labs belonging to this category
                const catLabs = selectedPt.Labs.filter(l => 
                    keywords.some(k => l.name.includes(k) || l.name === k)
                );

                if (catLabs.length === 0) return;

                // Create the Category Block
                const groupDiv = document.createElement('div');
                groupDiv.className = "flex flex-col gap-3";
                
                // Category Header
                groupDiv.innerHTML = `
                    <div class="flex items-center gap-2 border-b border-slate-100 pb-2 mb-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span>
                        <h3 class="text-[11px] font-bold text-slate-500 uppercase tracking-widest">${catName}</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        ${catLabs.map((l, index) => {
                            const realIndex = selectedPt.Labs.indexOf(l);
                            const isAbnormal = l.status === 'abnormal';
                            const isMissing = l.status === 'missing';

                            // Color Logic
                            let border = isAbnormal ? 'border-red-200' : 'border-slate-200';
                            let bg = isAbnormal ? 'bg-red-50/50' : 'bg-white';
                            let text = isAbnormal ? 'text-red-700' : 'text-slate-700';
                            let icon = l.trend === 'up' ? 'arrow-up-right' : l.trend === 'down' ? 'arrow-down-right' : 'minus';
                            
                            if (isMissing) {
                                border = 'border-slate-100';
                                bg = 'bg-slate-50';
                                text = 'text-slate-400';
                                icon = 'help-circle';
                            }

                            return `
                                <div onclick="openLabSidebar(${realIndex})" class="relative p-3 rounded border ${border} ${bg} cursor-pointer hover:shadow-md hover:border-indigo-300 transition-all group">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-[10px] font-bold text-slate-400 uppercase truncate">${l.name}</span>
                                        <i data-lucide="${icon}" class="w-3 h-3 ${isAbnormal ? 'text-red-500' : 'text-slate-300'}"></i>
                                    </div>
                                    <div class="flex items-baseline gap-1">
                                        <span class="text-sm font-black ${text}">${l.val}</span>
                                        <span class="text-[9px] font-medium text-slate-400">${l.unit}</span>
                                    </div>
                                    ${isAbnormal ? '<div class="absolute bottom-1 right-1 w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></div>' : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(groupDiv);
            });
            
            lucide.createIcons();
        }

        // SIDEBAR LOGIC
        function openLabSidebar(index) {
            const l = selectedPt.Labs[index];
            
            // Populate Text Info
            document.getElementById('labSidebarTitle').innerText = l.name;
            document.getElementById('labSidebarValue').innerText = l.val;
            document.getElementById('labSidebarUnit').innerText = l.unit;
            document.getElementById('labSidebarRange').innerText = l.range;

            // Status Badge
            const statusEl = document.getElementById('labSidebarStatus');
            const isAbnormal = l.status === 'abnormal';
            statusEl.innerHTML = `
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded text-[10px] font-black uppercase tracking-wide ${isAbnormal ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}">
                    ${isAbnormal ? '<i data-lucide="alert-circle" class="w-3 h-3"></i> Abnormal' : '<i data-lucide="check-circle" class="w-3 h-3"></i> Normal'}
                </span>
            `;

            // Open Sidebar Animation
            const sidebar = document.getElementById('labSidebar');
            const backdrop = document.getElementById('labSidebarBackdrop');
            backdrop.classList.remove('hidden');
            setTimeout(() => backdrop.classList.remove('opacity-0'), 10);
            sidebar.classList.remove('translate-x-full');
            
            lucide.createIcons(); // Refresh icons inside sidebar

            // RENDER CHART
            const ctx = document.getElementById('sidebarLabChart').getContext('2d');
            if (sidebarChartInstance) sidebarChartInstance.destroy();

            // Prepare Data
            const dataPoints = l.history.length > 0 ? l.history : [parseFloat(l.val)];
            const labels = dataPoints.map((_, i) => i === dataPoints.length - 1 ? 'Current' : `Prior ${dataPoints.length - 1 - i}`);
            const rangeData = parseRange(l.range);

            const datasets = [{
                label: l.name,
                data: dataPoints,
                borderColor: '#4f46e5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 2.5,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#4f46e5',
                pointRadius: 5,
                fill: true,
                tension: 0.3
            }];

            // Add Safety Limits (Dashed Lines)
            if (rangeData) {
                if (rangeData.max) {
                    datasets.push({
                        label: 'Upper Limit',
                        data: Array(labels.length).fill(rangeData.max),
                        borderColor: '#f87171', // Red-400
                        borderWidth: 1.5,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    });
                }
                if (rangeData.min > 0) { // Only show min if > 0
                    datasets.push({
                        label: 'Lower Limit',
                        data: Array(labels.length).fill(rangeData.min),
                        borderColor: '#f87171',
                        borderWidth: 1.5,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    });
                }
            }

            sidebarChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            mode: 'index', intersect: false, 
                            backgroundColor: '#1e293b', 
                            titleFont: { size: 10 }, 
                            bodyFont: { size: 12, weight: 'bold' } 
                        }
                    },
                    scales: {
                        y: { grid: { color: '#f1f5f9' }, ticks: { font: { size: 10, weight: 'bold' }, color: '#64748b' } },
                        x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' }, color: '#94a3b8' } }
                    }
                }
            });
        }

        function closeLabSidebar() {
            const sidebar = document.getElementById('labSidebar');
            const backdrop = document.getElementById('labSidebarBackdrop');
            sidebar.classList.add('translate-x-full');
            backdrop.classList.add('opacity-0');
            setTimeout(() => backdrop.classList.add('hidden'), 300);
        }

        // MODAL LOGIC
        function openLabModal(index) {
            const l = selectedPt.Labs[index];
            const modal = document.getElementById('labModal');
            
            // Populate Text
            document.getElementById('labModalTitle').innerText = l.name;
            document.getElementById('labModalValue').innerText = l.val;
            document.getElementById('labModalUnit').innerText = l.unit;
            document.getElementById('labModalRange').innerText = l.range;
            
            const badge = document.getElementById('labModalStatus');
            const isAbnormal = l.status === 'abnormal';
            badge.className = `inline-block px-3 py-1 rounded text-xs font-bold uppercase tracking-wide ${isAbnormal ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}`;
            badge.innerText = l.status;

            // Show Modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // CHART RENDERING
            const ctx = document.getElementById('detailLabChart').getContext('2d');
            
            // Destroy previous chart to avoid overlay issues
            if (labChartInstance) {
                labChartInstance.destroy();
            }

            // Parse Reference Range for Visualization
            const rangeData = parseRange(l.range);
            let annotations = {};
            
            // Create dataset for the lab values
            const dataPoints = l.history.length > 0 ? l.history : [parseFloat(l.val)];
            const labels = dataPoints.map((_, i) => i === dataPoints.length - 1 ? 'Current' : `T-${dataPoints.length - 1 - i}`);

            // Prepare datasets
            const datasets = [{
                label: l.name,
                data: dataPoints,
                borderColor: '#4f46e5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 3,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#4f46e5',
                pointRadius: 6,
                pointHoverRadius: 8,
                fill: true,
                tension: 0.3
            }];

            // Add Reference Lines as datasets (Hack for no annotation plugin)
            if (rangeData) {
                if (rangeData.max) {
                    datasets.push({
                        label: 'Upper Limit',
                        data: Array(labels.length).fill(rangeData.max),
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        borderDash: [6, 4],
                        pointRadius: 0,
                        fill: false
                    });
                }
                if (rangeData.min) {
                    datasets.push({
                        label: 'Lower Limit',
                        data: Array(labels.length).fill(rangeData.min),
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        borderDash: [6, 4],
                        pointRadius: 0,
                        fill: false
                    });
                }
            }

            labChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleFont: { size: 12 },
                            bodyFont: { size: 13, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: '#f1f5f9' },
                            ticks: { font: { weight: 'bold' }, color: '#64748b' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { weight: 'bold' }, color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function closeLabModal() {
            document.getElementById('labModal').classList.add('hidden');
            document.getElementById('labModal').classList.remove('flex');
        }

        // function renderAISummary() {
        //     const list = document.getElementById('aiSummaryPoints');
        //     list.innerHTML = selectedPt.AISummary.map(p => `
        //         <li class="flex gap-3 leading-relaxed">
        //             <i data-lucide="chevron-right" class="w-3.5 h-3.5 shrink-0 text-indigo-400 mt-0.5"></i>
        //             <span>${p}</span>
        //         </li>
        //     `).join('');
        // }


        function renderAISummary() {
    // Renders the main summary bullets
    document.getElementById('aiSummaryPoints').innerHTML = selectedPt.AISummary.map(p => 
        `<li class="flex gap-3 leading-relaxed"><i data-lucide="chevron-right" class="w-3.5 h-3.5 shrink-0 text-indigo-400 mt-0.5"></i><span>${p}</span></li>`
    ).join('');

    // Renders the new Next Steps box
    const nextStepsList = document.getElementById('aiNextSteps');
    if (selectedPt.NextSteps) {
        nextStepsList.innerHTML = selectedPt.NextSteps.map(s => `<li>${s}</li>`).join('');
    } else {
        nextStepsList.innerHTML = "<li>No immediate actions identified. Maintain current surveillance.</li>";
    }
}

        function renderMolecular() {
            const container = document.getElementById('molecularList');
            container.innerHTML = "";
            ['EGFR', 'ALK', 'KRAS', 'PDL1', 'MSI', 'TMB', 'ER', 'PR', 'HER2'].forEach(m => {
                if (selectedPt[m]) {
                    container.innerHTML += `<div class="flex justify-between items-center py-2 border-b border-slate-50"><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${m}</span><span class="text-[11px] font-bold ${selectedPt[m]!=='Negative' && selectedPt[m]!=='MSS' ? 'text-indigo-600':'text-slate-400'}">${selectedPt[m]}</span></div>`;
                }
            });
            container.innerHTML += `<div class="mt-4 p-4 bg-slate-50 text-[11px] font-medium text-slate-600 border border-slate-100 leading-relaxed italic">${selectedPt.Biology}</div>`;
        }

        function clearCharts() { charts.forEach(c => c.destroy()); charts = []; }

        function init() {
            const selector = document.getElementById('patientSelect');
            PATIENTS.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.ID; opt.innerText = p.ID; selector.appendChild(opt);
            });
            renderDashboard();
        }

        window.onload = init;
    </script>
</body>
</html>
